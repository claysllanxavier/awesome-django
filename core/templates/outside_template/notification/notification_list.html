{% extends "outside_template/base.html" %}
{% load boilerplate_base static %}

{% block content %}
    <div class="row">
        <div class="col-12">


            <ul class="nav justify-content-center nav-tabs" id="myTab" role="tablist">
                <li class="nav-item text-center" style="width: 50%">
                    <a class="nav-link" id="not_reads-tab" data-toggle="tab" href="#not_reads" role="tab"
                       aria-controls="not_reads" aria-selected="true">
                        <i class="fa fa-comment"></i>
                        NÃO VISTAS
                    </a>
                </li>
                <li class="nav-item text-center" style="width: 50%">
                    <a class="nav-link" id="reads-tab" data-toggle="tab" href="#reads" role="tab"
                       aria-controls="reads" aria-selected="false">
                        <i class="fa fa-comment"></i>
                        JÁ VISTAS
                    </a>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade" id="not_reads" role="tabpanel" aria-labelledby="not_reads-tab">
                    {% if notifications_not_reads.object_list %}

                        <table class="table table-striped table-hover">
                            <thead>
                            <tr>
                                <td colspan="4">
                                    <input id="checkall" type="checkbox">
                                    <label for="checkall">Marcar Todos</label>

                                    <button style="margin-left: -10px;" id="btn_marcar_visto"
                                            onclick="processar_marcados();"
                                            class="btn btn-primary invisible" type="button">
                                        Marcar como visto(s)
                                    </button>

                                </td>
                            </tr>
                            </thead>
                            <tbody>
                            {% for obj in notifications_not_reads.object_list %}

                                <tr>
                                    <td>
                                        <input type="checkbox" class="chk_list"
                                               id="id_{{ obj.id|safe }}"
                                               name="chk_{{ obj.id|safe }}" data-notificacao="{{ obj.id|safe }}"/>
                                    </td>
                                    <td onclick='window.open("{{ obj.get_url|default_if_none:'#' }}","_self")'>
                                        {{ obj.remetente|default_if_none:'' }}
                                    </td>
                                    <td onclick='window.open("{{ obj.get_url|default_if_none:'#' }}","_self")'>
                                        {{ obj.mensagem|default_if_none:'' }}
                                    </td>
                                    <td onclick='window.open("{{ obj.get_url|default_if_none:'#' }}","_self")'>
                                        {{ obj.data_envio_f|default_if_none:'' }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                            {% include 'outside_template/notification/notification_paginator.html' with object_list=notifications_not_reads prefix_page='notifications_not_reads' id_tab='not_reads-tab' qtd_campos=4 %}
                        </table>
                    {% else %}
                        <p style="padding: 20px; font-size: 20px; font-weight: bold; text-align: center; color: #aaa">
                            <i class="fa fa-smile" style="font-size: 80px; vertical-align: middle"></i>
                            <br/>
                            Sem notificações.
                        </p>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="reads" role="tabpanel" aria-labelledby="reads-tab">
                    {% if notifications_reads.object_list %}
                        <table class="table table-striped table-hover">
                            <tbody>
                            {% for obj in notifications_reads.object_list %}
                                <tr onclick='window.open("{{ obj.get_url|default_if_none:'#' }}","_self")'>
                                    <td>
                                        {{ obj.remetente|default_if_none:'' }}
                                    </td>
                                    <td>
                                        {{ obj.mensagem|default_if_none:'' }}
                                    </td>
                                    <td>
                                        {{ obj.data_envio_f|default_if_none:'' }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                            {% include 'outside_template/notification/notification_paginator.html' with object_list=notifications_reads prefix_page='notifications_reads' id_tab='reads-tab' qtd_campos=4 %}
                        </table>
                    {% else %}
                        <p style="padding: 20px; font-size: 20px; font-weight: bold; text-align: center; color: #aaa">
                            <i class="fa fa-smile" style="font-size: 80px; vertical-align: middle"></i>
                            <br/>
                            Sem notificações.
                        </p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>


{% endblock content %}


{% block extra_js %}
    <script>
        jQuery(document).ready(function () {
            {#codigo  das gias#}
            {% if id_tab %}
                {% if id_tab == 'reads-tab' %}
                    $('#myTab li:last-child a').tab('show')
                {% else %}
                    $('#not_reads-tab').tab('show');
                {% endif %}
            {% else %}
                $('#not_reads-tab').tab('show');
            {% endif %}

            {#        codigo dos checbox#}
            $('#checkall').change(function () {
                if ($(this).is(':checked')) {
                    $('.chk_list').prop('checked', true);
                    $('#btn_marcar_visto').removeClass('invisible');
                } else {
                    $('.chk_list').prop('checked', false);
                    $('#btn_marcar_visto').addClass('invisible');
                }
            });

        });
        $('.chk_list').change(function () {
            if ($(this).is(':checked')) {
                if ($('#btn_marcar_visto').hasClass('invisible')) {
                    $('#btn_marcar_visto').removeClass('invisible');
                }
            } else {
                if (!TestCheckboxes()) {
                    $('#btn_marcar_visto').addClass('invisible');
                }
            }
        });

        function TestCheckboxes() {
            var checkboxes = document.getElementsByClassName('chk_list');
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    return true;
                }
            }
            return false;
        }

        function capturar_ids() {
            var checkbox = [];
            $(".chk_list").each(function () {
                if ($(this).is(":checked")) {
                    checkbox.push($(this).data("notificacao"));
                }
            });
            return checkbox;
        }

        function processar_marcados() {
            $.post("{% url 'core:marcar_vistos' %}", {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'chk_noti_ids': capturar_ids()
            }).done(function (data) {
                alert(data);
                $('#checkall').prop('checked', false);
                window.location.reload();
            });
        }
    </script>
{% endblock extra_js %}
